{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            try {
                const savedConfigs = document.getElementById('step-configs').value;
                if (savedConfigs) {
                    allConfigs = JSON.parse(savedConfigs);
                    console.log("Restored allConfigs:", allConfigs);
                }
            } catch (err) {
                console.warn("Failed to parse step-configs:", err);
            }

            const toggleButton = document.getElementById("theme-toggle");
            if (!toggleButton) return;

            function applyThemeMode() {
                const mode = localStorage.getItem("theme-mode") || "system";
                document.documentElement.dataset.theme = mode;
                toggleButton.textContent =
                    mode === "dark" ? "‚òÄ" :
                        mode === "light" ? "üåô" :
                            "üåó";  // system
            }

            toggleButton.addEventListener("click", () => {
                const current = localStorage.getItem("theme-mode") || "system";
                const next =
                    current === "system" ? "light" :
                        current === "light" ? "dark" : "system";
                localStorage.setItem("theme-mode", next);
                applyThemeMode();
            });

            applyThemeMode();

            // üß© 3. Modal open logic
            document.getElementById('workflow-canvas').addEventListener('click', function (e) {
                const li = e.target.closest('li');
                if (li && li.dataset.type && li.dataset.stepId) {
                    const stepType = li.dataset.type;
                    const stepId = li.dataset.stepId;
                    openStepModal(stepType, stepId);
                }
            });

        });
    </script>


{% endblock %}

{% block content %}
    <div id="theme-toggle-container" style="position: absolute; top: 10px; right: 16px;">
        <button id="theme-toggle" style="background: none; border: none; font-size: 18px; cursor: pointer;">üåó</button>
    </div>

    <h1>{{ workflow.name }} ‚Äì Builder</h1>

    <div style="display: flex; gap: 2rem;">
        <!-- Toolbox -->
        <div>
            <h3>Steps</h3>
            <div id="step-menu">
                <div class="draggable" data-type="form" draggable="true">‚ûï Form</div>
                <div class="draggable" data-type="email" draggable="true">üìß Email</div>
                <div class="draggable" data-type="timer" draggable="true">‚è≤Ô∏è Timer</div>
                <div class="draggable" data-type="approval" draggable="true">‚úÖ Approval</div>
                <div class="draggable" data-type="condition" draggable="true">üîÄ Condition</div>
                <div class="draggable" data-type="webhook" draggable="true">üåê Webhook</div>
            </div>
        </div>

        <!-- Drop Area -->
        <div>
            <h3>Workflow Canvas</h3>
            <form method="post" id="builder-form">
                {% csrf_token %}
                <ul id="workflow-canvas" class="dropzone">
                    {% for step in workflow.steps.all %}
                        <li data-type="{{ step.step_type }}" data-step-id="{{ step.id }}">
                            <span class="step-label">{{ step.name }}</span>
                            <button class="delete-step" title="Remove this step">‚úñ</button>
                        </li>
                    {% endfor %}
                </ul>

                <input type="hidden" name="step_data" id="step-data">
                <input type="hidden" name="step_configs" id="step-configs" value='{{ step_configs_json|safe }}'>
                <button type="submit">üíæ Save Workflow</button>
            </form>
        </div>
    </div>

    <!-- Modal -->
    <div id="step-config-modal" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
  background: white; border: 1px solid #ccc; padding: 1rem; z-index: 1000; width: 400px; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
        <h3 id="modal-title">Configure Step</h3>
        <form id="modal-form">
            <div id="modal-body"></div>
            <button type="submit">Save</button>
            <button type="button" onclick="closeStepModal()">Cancel</button>
        </form>
    </div>


    <style>

        .draggable, .dropzone li {
            padding: 8px;
            border: 1px solid #ccc;
            margin: 4px;
            cursor: grab;
            background: #f9f9f9;
            color: #000; /* Force readable text */
            font-weight: bold;
        }

        .draggable:hover {
            background: #e1e1e1;
        }

        .dropzone {
            list-style: none;
            min-height: 200px;
            padding: 10px;
            border: 2px dashed #aaa;
        }

        #step-config-modal {
            background-color: var(--body-bg, #222) !important;
            color: var(--body-fg, #eee) !important;
            border: 1px solid var(--border-color, #666) !important;
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
        }

        #step-config-modal label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            color: var(--body-fg, #eee) !important;
        }

        #step-config-modal input,
        #step-config-modal select,
        #step-config-modal textarea {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            margin-bottom: 10px;
            color: var(--body-fg, #eee) !important;
            background-color: var(--darkened-bg, #333) !important;
            border: 1px solid var(--border-color, #666) !important;
            border-radius: 4px;
        }

        .delete-step {
            float: right;
            background: transparent;
            border: none;
            color: red;
            cursor: pointer;
            font-weight: bold;
        }


    </style>


    <script>
        let allConfigs = {};
        const stepCounters = {
            form: 0,
            email: 0,
            timer: 0,
            approval: 0
        };

        // Make toolbox items draggable
        const draggables = document.querySelectorAll('.draggable');
        draggables.forEach(item => {
            item.addEventListener('dragstart', e => {
                e.dataTransfer.setData('type', item.dataset.type);
                e.dataTransfer.setData('origin', 'sidebar');
            });
        });


        // Drop area
        const dropzone = document.getElementById('workflow-canvas');
        dropzone.addEventListener('dragover', e => e.preventDefault());
        dropzone.addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-step')) {
                e.preventDefault();
                const li = e.target.closest('li');
                li.remove();
            }
        });

        dropzone.addEventListener('drop', e => {
            e.preventDefault();

            const type = e.dataTransfer.getData('type');
            const origin = e.dataTransfer.getData('origin');

            // Only add new step if dragged from sidebar
            if (origin !== 'sidebar') return;

            stepCounters[type] += 1;

            const li = document.createElement('li');
            li.dataset.type = type;
            {#li.dataset.stepId = step.id; // ‚úÖ ADD THIS#}
            li.dataset.stepId = `temp-${Date.now()}-${Math.floor(Math.random() * 1000)}`;  // ‚úÖ important
            li.innerHTML = `
        <span class="step-label">${type.charAt(0).toUpperCase() + type.slice(1)} Step ${stepCounters[type]}</span>
        <button class="delete-step" title="Remove this step">‚úñ</button>
    `;

            // Re-draggable for future sorting
            li.setAttribute('draggable', 'true');
            li.addEventListener('dragstart', function (e) {
                e.dataTransfer.setData('type', type);
                e.dataTransfer.setData('origin', 'canvas');
            });

            dropzone.appendChild(li);
        });


        // Sortable.js
        new Sortable(dropzone, {
            animation: 150,
            ghostClass: 'blue-background-class',
            onEnd: () => {
                // Update all <li> with new data-index
                document.querySelectorAll('#workflow-canvas li').forEach((li, i) => {
                    li.dataset.index = i;
                });
            }
        });
        document.getElementById('modal-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const modal = document.getElementById('step-config-modal');
            const stepId = modal.dataset.stepId;
            const stepType = modal.dataset.type;

            const formData = new FormData(e.target);
            const config = {};

            formData.forEach((value, key) => {
                config[key] = value;
            });

            // üîΩ Special handling for form fields:
            if (stepType === 'form') {
                const fields = [];
                document.querySelectorAll('.field-row').forEach((row, i) => {
                    fields.push({
                        label: row.querySelector(`[name=field_label_${i}]`).value,
                        field_type: row.querySelector(`[name=field_type_${i}]`).value,
                        required: row.querySelector(`[name=field_required_${i}]`).checked,
                        choices: row.querySelector(`[name=field_choices_${i}]`).value,
                    });
                });
                config["fields"] = fields;
            }

            // ‚úÖ Save config to the global variable
            allConfigs[stepId] = config;

            closeStepModal();
        });


        document.addEventListener('DOMContentLoaded', function () {
            // üîÅ Restore allConfigs
            try {
                const savedConfigs = document.getElementById('step-configs').value;
                if (savedConfigs) {
                    allConfigs = JSON.parse(savedConfigs);
                    console.log("Restored allConfigs:", allConfigs);
                }
            } catch (err) {
                console.warn("Failed to parse step-configs:", err);
            }

            document.getElementById('workflow-canvas').addEventListener('click', function (e) {
                const li = e.target.closest('li');
                if (li && li.dataset.type) {
                    const stepType = li.dataset.type;
                    const stepId = li.dataset.stepId;
                    openStepModal(stepType, stepId);
                }
            });
            // ‚úÖ Reset data-index on each li based on order in DOM
            document.querySelectorAll('#workflow-canvas li').forEach((li, i) => {
                li.dataset.index = i;
            });

        });


        function openStepModal(stepType, stepId) {
            const modal = document.getElementById('step-config-modal');
            const body = document.getElementById('modal-body');
            document.getElementById('modal-title').textContent = `Configure ${stepType} step`;

            const config = allConfigs[stepId] || {};  // ‚úÖ load config

            const fields = {
                form: `
          <label>Title: <input name="title" required value="${config.title || ''}"></label><br><br>
          <div id="field-configs"></div>
        `,
                email: `
          <label>Subject: <input name="subject" required value="${config.subject || ''}"></label><br>
          <label>Body:<br><textarea name="body" rows="4">${config.body || ''}</textarea></label>
        `,
                timer: `<label>Delay (in seconds): <input name="delay" type="number" min="1" required value="${config.delay || ''}"></label>`,
                approval: `<label>Approver Email: <input name="approver" value="${config.approver || ''}"></label>`,
                condition: `<label>Condition logic: <input name="logic" value="${config.logic || ''}" placeholder="e.g. amount > 10000"></label>`,
                webhook: `<label>Webhook URL: <input name="url" type="url" value="${config.url || ''}"></label>`
            };

            body.innerHTML = fields[stepType] || `<p>No config available for this type.</p>`;


            // üîÅ Load form fields if it's a form step
            if (stepType === 'form') {
                const savedFields = config.fields || [];
                savedFields.forEach((field, i) => addFieldRow(field, i));

                const addFieldBtn = document.createElement('button');
                addFieldBtn.type = 'button';
                addFieldBtn.innerHTML = '‚ûï Add Field';
                addFieldBtn.onclick = () => addFieldRow();
                document.getElementById('field-configs').after(addFieldBtn);
            }


            modal.dataset.stepId = stepId;
            modal.dataset.type = stepType;
            modal.style.display = 'block';

            console.log("Modal opened with config:", config);
        }


        function addFieldRow(field = {}, index = null) {
            if (index === null) {
                index = document.querySelectorAll('.field-row').length;
            }

            const row = document.createElement('div');
            row.className = 'field-row';
            row.innerHTML = `
        <label>Label: <input name="field_label_${index}" value="${field.label || ''}"></label>
        <label>Type:
            <select name="field_type_${index}">
                <option value="text" ${field.field_type === 'text' ? 'selected' : ''}>Text</option>
                <option value="textarea" ${field.field_type === 'textarea' ? 'selected' : ''}>Textarea</option>
                <option value="email" ${field.field_type === 'email' ? 'selected' : ''}>Email</option>
                <option value="number" ${field.field_type === 'number' ? 'selected' : ''}>Number</option>
                <option value="date" ${field.field_type === 'date' ? 'selected' : ''}>Date</option>
                <option value="file" ${field.field_type === 'file' ? 'selected' : ''}>File</option>
                <option value="choice" ${field.field_type === 'choice' ? 'selected' : ''}>Dropdown</option>
            </select>
        </label>
        <label>Required: <input type="checkbox" name="field_required_${index}" ${field.required ? 'checked' : ''}></label>
        <label>Choices (CSV): <input name="field_choices_${index}" value="${field.choices || ''}"></label>
        <br>
    `;
            document.getElementById('field-configs').appendChild(row);
        }


        function closeStepModal() {
            document.getElementById('step-config-modal').style.display = 'none';
        }


        const toggleButton = document.querySelector(".theme-toggle");

        if (toggleButton) {
            toggleButton.addEventListener("click", () => {
                const current = localStorage.getItem("theme-mode") || "system";
                const next = current === "system" ? "light" : current === "light" ? "dark" : "system";
                localStorage.setItem("theme-mode", next);
                applyThemeMode();
            });

            function applyThemeMode() {
                const mode = localStorage.getItem("theme-mode") || "system";
                document.documentElement.dataset.theme = mode;
                toggleButton.textContent = mode === "dark" ? "‚òÄ" : mode === "light" ? "üåì" : "‚òæ";
            }

            applyThemeMode();
        }
        {# My Form Submit Handler #}
        document.getElementById('builder-form').addEventListener('submit', function (e) {
            const steps = [];
            document.querySelectorAll('#workflow-canvas li').forEach((li, index) => {
                const label = li.querySelector('.step-label')?.innerText || `Step ${index + 1}`;
                steps.push({
                    id: li.dataset.stepId,
                    order: index + 1,
                    type: li.dataset.type,
                    name: label
                });
                document.getElementById('step-data').value = JSON.stringify(steps);
                document.getElementById('step-configs').value = JSON.stringify(allConfigs);  // ‚úÖ THIS LINE
            });

            // üîç Optional debugging
            console.log('STEP LIST:');
            steps.forEach((step, i) => {
                console.log(`Step ${i + 1}:`, step);
            });

            // ‚úÖ Inject JSON data into hidden inputs
            document.getElementById('step-data').value = JSON.stringify(steps);
            document.getElementById('step-configs').value = JSON.stringify(allConfigs);
        });


    </script>
{% endblock %}