{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'core/workflow_builder.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}


{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}">Home</a>
        ‚Ä∫ <a href="{% url 'admin:core_workflow_changelist' %}">Workflows</a>
        ‚Ä∫ {{ workflow.name }} ‚Äì Builder
    </div>
{% endblock %}

{% block content_title %}
    <h1>{{ workflow.name }} ‚Äì Builder</h1>
{% endblock %}



{% block content %}
    <!-- For notification on save instead of browser Notification feature. -->
    <div id="notification" style="display:none; padding: 10px; margin-bottom: 20px; border-radius: 4px;"></div>

    {#    <h1>{{ workflow.name }} ‚Äì Builder</h1>#}

    <div style="display: flex; gap: 2rem;">
        <!-- Toolbox -->
        <div>
            <h3>Steps</h3>
            <div id="step-menu">
                <div class="draggable" data-type="form" draggable="true">‚ûï Form</div>
                <div class="draggable" data-type="email" draggable="true">üìß Email</div>
                <div class="draggable" data-type="timer" draggable="true">‚è≤Ô∏è Timer</div>
                <div class="draggable" data-type="approval" draggable="true">‚úÖ Approval</div>
                <div class="draggable" data-type="condition" draggable="true">üîÄ Condition</div>
                <div class="draggable" data-type="webhook" draggable="true">üåê Webhook</div>
            </div>
        </div>

        <!-- Canvas -->
        <div>
            <h3>Workflow Canvas</h3>
            <ul id="workflow-canvas" class="dropzone">
                {% for step in workflow.steps.all %}
                    <li data-type="{{ step.step_type }}" data-step-id="{{ step.id }}">
                        <span class="step-label">{{ step.name }}</span>
                        <button class="delete-step" title="Remove this step">‚úñ</button>
                    </li>
                {% endfor %}
            </ul>
            <button id="save-workflow" class="button">üíæ Save Workflow</button>
        </div>
    </div>

    <!-- Hidden CSRF form -->
    <form style="display: none">{% csrf_token %}</form>

    <!-- Modal -->
    <div id="step-config-modal"
         style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); border: 1px solid #ccc; padding: 1rem; z-index: 1000; width: 400px;">
        <h3 id="modal-title">Configure Step</h3>
        <form id="modal-form">
            <div id="modal-body"></div>
            <button type="submit">Save</button>
            <button type="button" onclick="closeStepModal()">Cancel</button>
        </form>
    </div>


    <script>
        window.allConfigs = {};
        try {
            window.allConfigs = {{ step_configs_json|safe }};
        } catch (e) {
            console.warn("step_configs_json load error:", e);
        }
    </script>
    <script src="{% static 'core/workflow_builder.js' %}"></script>
{% endblock %}
