{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}


{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}">Home</a>
        ‚Ä∫ <a href="{% url 'admin:core_workflow_changelist' %}">Workflows</a>
        ‚Ä∫ {{ workflow.name }} ‚Äì Builder
    </div>
{% endblock %}

{% block content_title %}
    <h1>{{ workflow.name }} ‚Äì Builder</h1>
{% endblock %}


{% block content %}
    <!-- For notification on save instead of browser Notification feature. -->
    <div id="notification" style="display:none; padding: 10px; margin-bottom: 20px; border-radius: 4px;"></div>

    {#    <h1>{{ workflow.name }} ‚Äì Builder</h1>#}

    <div style="display: flex; gap: 2rem;">
        <!-- Toolbox -->
        <div>
            <h3>Steps</h3>
            <div id="step-menu">
                <div class="draggable" data-type="form" draggable="true">‚ûï Form</div>
                <div class="draggable" data-type="email" draggable="true">üìß Email</div>
                <div class="draggable" data-type="timer" draggable="true">‚è≤Ô∏è Timer</div>
                <div class="draggable" data-type="approval" draggable="true">‚úÖ Approval</div>
                <div class="draggable" data-type="condition" draggable="true">üîÄ Condition</div>
                <div class="draggable" data-type="webhook" draggable="true">üåê Webhook</div>
            </div>
        </div>

        <!-- Canvas -->
        <div>
            <h3>Workflow Canvas</h3>
            <ul id="workflow-canvas" class="dropzone">
                {% for step in workflow.steps.all %}
                    <li data-type="{{ step.step_type }}" data-step-id="{{ step.id }}">
                        <span class="step-label">{{ step.name }}</span>
                        <button class="delete-step" title="Remove this step">‚úñ</button>
                    </li>
                {% endfor %}
            </ul>
            <button id="save-workflow" class="button">üíæ Save Workflow</button>
        </div>
    </div>

    <!-- Hidden CSRF form -->
    <form style="display: none">{% csrf_token %}</form>

    <!-- Modal -->
    <div id="step-config-modal"
         style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); border: 1px solid #ccc; padding: 1rem; z-index: 1000; width: 400px;">
        <h3 id="modal-title">Configure Step</h3>
        <form id="modal-form">
            <div id="modal-body"></div>
            <button type="submit">Save</button>
            <button type="button" onclick="closeStepModal()">Cancel</button>
        </form>
    </div>

    <style>

        :root {
        {#--text-color: #000;#}{#--text-color: #000;#}{#--bg-color: #f9f9f9;#} --text-color: #f9f9f9;
            --bg-color: #333;
            --border-color: #ccc;
            --btn-bg: #eee;
            --btn-text: #000;
            --btn-bg-hover: #ddd;
        }

        /* Dark mode */
        html[data-theme="dark"] {
            --text-color: #f9f9f9;
            --bg-color: #333;
            --border-color: #666;
            --btn-bg: #3b3b3b;
            --btn-text: #fff;
            --btn-bg-hover: #444;
        }

        /* Light mode */
        html[data-theme="light"] {
            --text-color: #111;
            --bg-color: #f9f9f9;
            --border-color: #ccc;
            --btn-bg: #e9e9e9;
            --btn-text: #000;
            --btn-bg-hover: #ddd;
        }

        /* === System theme fallback === */
        html:not([data-theme]) .draggable,
        html:not([data-theme]) .dropzone li {
        {#background-color: #e8e8e8; background-color: #f0f0f0;#} border: 1px solid #ccc;
            /*color: #000; color: #000 !important;  üî¥ Force black */
            font-weight: bold;
        }

        html:not([data-theme]) .step-label {
            color: #000;
        }

        html:not([data-theme]) #save-workflow {
            background-color: #f0f0f0;
            color: #000;
            border-color: #aaa;
        }


        /* === Restore Workflow Canvas dashed border === */
        .dropzone {
            min-height: 200px;
            padding: 14px;
            border: 2px dashed var(--border-color, #aaa);
            list-style: none;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        /* === Shared Styling for all themes === */
        .dropzone li,
        .draggable {
            padding: 8px;
            border: 1px solid var(--border-color, #ccc);
            margin: 4px;
            background: var(--bg-color, #f9f9f9);
            cursor: grab;
            font-weight: bold;
            border-radius: 4px;
            color: var(--text-color);
        }

        .step-label {
            color: var(--text-color, #000);
        }

        #save-workflow {
            padding: 6px 12px;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid #aaa;
            background-color: var(--btn-bg, #eee);
            color: var(--btn-text, #000);
            transition: background 0.2s;
        }

        #save-workflow:hover {
            background-color: var(--btn-bg-hover, #ddd);
        }

        .delete-step {
            background: transparent;
            color: red;
            border: none;
            font-weight: bold;
            margin-left: 8px;
            cursor: pointer;
        }

        .step-saved {
            background-color: #75c88b !important; /* Light green */
            transition: background-color 1s ease;
        }


        /* === Dark Mode Theme Compatibility === */
        html[data-theme="dark"] .draggable,
        html[data-theme="dark"] .dropzone li {
            --bg-color: #333;
            --text-color: #f9f9f9;
            --border-color: #666;
        }

        html[data-theme="dark"] .step-label {
            color: #fff;
        }

        html[data-theme="dark"] #save-workflow {
            --btn-bg: #3b3b3b;
            --btn-text: #fff;
            --btn-bg-hover: #444;
        }

        /* Modal Specific */
        html[data-theme="dark"] #step-config-modal {
            background-color: #2b2b2b;
            color: #f1f1f1;
            border: 1px solid #666;
        }

        html[data-theme="dark"] #step-config-modal input,
        html[data-theme="dark"] #step-config-modal select,
        html[data-theme="dark"] #step-config-modal textarea {
            background-color: #1e1e1e;
            color: #f1f1f1;
            border: 1px solid #555;
        }

        /* Optional: Light theme enhancements */
        html[data-theme="light"] .dropzone li,
        html[data-theme="light"] .draggable {
            background-color: #f9f9f9;
            border-color: #ccc;
            color: #111;
        }

        html[data-theme="light"] #save-workflow {
            background-color: #e9e9e9;
            color: #000;
            border-color: #aaa;
        }

        /* Light theme modal */
        html[data-theme="light"] #step-config-modal {
            background-color: white;
            color: #333;
            border: 1px solid #ccc;
        }

        /* Default/fallback theme (system or unknown) */
        html:not([data-theme]) .draggable,
        html:not([data-theme]) .dropzone li {
            background-color: #f0f0f0;
            border: 1px dashed #999;
            color: #111;
        }

        html:not([data-theme]) .step-label {
            color: #111;
        }

        html:not([data-theme]) #save-workflow {
            background-color: #f0f0f0;
            color: #000;
            border-color: #aaa;
        }

        /* Default theme modal */
        html:not([data-theme]) #step-config-modal {
            background-color: white;
            color: #333;
            border: 1px solid #ddd;
        }

    </style>


    <script>
        let allConfigs = {};
        const stepCounters = {form: 0, email: 0, timer: 0, approval: 0, condition: 0, webhook: 0};

        // Show Notification ()
        function showNotification(message, type = 'success', duration = 5000) {
            const notif = document.getElementById("notification");
            notif.className = type;
            notif.textContent = message;
            notif.style.display = 'block';
            notif.classList.add("show");
            setTimeout(() => notif.classList.remove("show"), duration - 500);

            setTimeout(() => {
                notif.style.display = 'none';
                notif.className = '';
                notif.textContent = '';
            }, duration);

        }

        function renumberStepsByType() {
            const dropzone = document.getElementById('workflow-canvas');
            const steps = dropzone.querySelectorAll('li');

            const counters = {};  // { form: 1, timer: 2, ... }

            steps.forEach(li => {
                const type = li.dataset.type;
                if (!counters[type]) counters[type] = 1;
                else counters[type]++;

                const label = li.querySelector('.step-label');
                if (label) {
                    label.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Step ${counters[type]}`;
                }
            });
        }


        document.addEventListener("DOMContentLoaded", function () {
            // Restore config from backend
            try {
                allConfigs = {{ step_configs_json|safe }};
            } catch (e) {
                allConfigs = {};
            }

            // üü¢ Make toolbox draggable
            document.querySelectorAll('.draggable').forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('type', item.dataset.type);
                    e.dataTransfer.setData('origin', 'sidebar');
                });
            });

            const dropzone = document.getElementById('workflow-canvas');

            // üü¢ Drop logic
            dropzone.addEventListener('dragover', e => e.preventDefault());

            dropzone.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('type');
                const origin = e.dataTransfer.getData('origin');
                if (origin !== 'sidebar') return;

                stepCounters[type] += 1;
                const stepId = `temp-${Date.now()}-${Math.floor(Math.random() * 1000)}`;

                const li = document.createElement('li');
                li.dataset.type = type;
                li.dataset.stepId = stepId;
                li.innerHTML = `
      <span class="step-label">${type.charAt(0).toUpperCase() + type.slice(1)} Step ${stepCounters[type]}</span>
      <button class="delete-step" title="Remove this step">‚úñ</button>
    `;

                li.setAttribute('draggable', 'true');
                li.addEventListener('dragstart', function (e) {
                    e.dataTransfer.setData('type', type);
                    e.dataTransfer.setData('origin', 'canvas');
                });

                dropzone.appendChild(li);
                renumberStepsByType();

            });

            // üü¢ Delete step
            dropzone.addEventListener('click', function (e) {
                if (e.target.classList.contains('delete-step')) {
                    e.preventDefault();
                    e.stopPropagation();  // ‚úÖ prevent modal from opening
                    e.target.closest('li').remove();
                    renumberStepsByType();  // üîÅ Recalculate step numbers
                    return;
                }

                const li = e.target.closest('li');
                if (li) {
                    openStepModal(li.dataset.type, li.dataset.stepId);
                }
            });

            // üü¢ Make sortable
            new Sortable(dropzone, {
                animation: 150,
                onEnd: () => {
                    document.querySelectorAll('#workflow-canvas li').forEach((li, i) => {
                        li.dataset.index = i;
                    });
                    renumberStepsByType();  // üîÅ Live renumber after reorder
                }
            });

            // * üü¢ Modal open
            /*dropzone.addEventListener('click', function (e) {
                const li = e.target.closest('li');
                if (!li) return;
                openStepModal(li.dataset.type, li.dataset.stepId);
            }); */

            // üü¢ Modal form save
            document.getElementById('modal-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const modal = document.getElementById('step-config-modal');
                const stepId = modal.dataset.stepId;
                const config = {};
                const stepType = modal.dataset.type;
                if (stepType === 'form') {
                    const fields = [];
                    document.querySelectorAll('.field-row').forEach((row, i) => {
                        fields.push({
                            label: row.querySelector(`[name=field_label_${i}]`)?.value || '',
                            field_type: row.querySelector(`[name=field_type_${i}]`)?.value || 'text',
                            required: row.querySelector(`[name=field_required_${i}]`)?.checked || false,
                            choices: row.querySelector(`[name=field_choices_${i}]`)?.value || '',
                        });
                    });
                    config.fields = fields;
                }
                const formData = new FormData(e.target);

                formData.forEach((val, key) => config[key] = val);
                allConfigs[stepId] = config;
                closeStepModal();

                // üîÅ Highlight saved step temporarily
                const savedLi = document.querySelector(`#workflow-canvas li[data-step-id="${stepId}"]`);
                if (savedLi) {
                    savedLi.classList.add("step-saved");
                    setTimeout(() => savedLi.classList.remove("step-saved"), 1500);
                }
            });

            // üü¢ Save to backend via fetch
            document.getElementById("save-workflow").addEventListener("click", function () {
                const steps = [];
                document.querySelectorAll("#workflow-canvas li").forEach((li, index) => {
                    steps.push({
                        id: li.dataset.stepId,
                        order: index + 1,
                        type: li.dataset.type,
                        name: li.querySelector(".step-label")?.innerText || `Step ${index + 1}`
                    });
                });

                fetch(window.location.href, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken(),
                    },
                    body: JSON.stringify({steps: steps, configs: allConfigs})
                })
                    .then(res => res.json())
                    .then(data => {
                        {#if (data.success) alert("‚úÖ Workflow saved!");#}
                        {#else alert("‚ùå Failed to save.");#}
                        if (data.success) {
                            showNotification("‚úÖ Workflow saved!", "success");
                        } else {
                            showNotification("‚ùå Failed to save workflow.", "error");
                        }
                    })
                    .catch(err => {
                        alert("‚ùå Save failed.");
                        console.error(err);
                    });
            });

        });

        function addFieldRow(field = {}, index = null) {
            if (index === null) {
                index = document.querySelectorAll(".field-row").length;
            }

            const row = document.createElement("div");
            row.className = "field-row";
            row.innerHTML = `
    <label>Label: <input name="field_label_${index}" value="${field.label || ''}"></label>
    <label>Type:
      <select name="field_type_${index}">
        <option value="text" ${field.field_type === 'text' ? 'selected' : ''}>Text</option>
        <option value="textarea" ${field.field_type === 'textarea' ? 'selected' : ''}>Textarea</option>
        <option value="email" ${field.field_type === 'email' ? 'selected' : ''}>Email</option>
        <option value="number" ${field.field_type === 'number' ? 'selected' : ''}>Number</option>
        <option value="date" ${field.field_type === 'date' ? 'selected' : ''}>Date</option>
        <option value="file" ${field.field_type === 'file' ? 'selected' : ''}>File</option>
        <option value="choice" ${field.field_type === 'choice' ? 'selected' : ''}>Dropdown</option>
      </select>
    </label>
    <div class="field-inline">
      <label for="field_required_${index}">Required:</label>
      <input type="checkbox" id="field_required_${index}" name="field_required_${index}" ${field.required ? 'checked' : ''}>
    </div>

    <label>Choices (CSV): <input name="field_choices_${index}" value="${field.choices || ''}"></label>
    <br><br>
  `;
            document.getElementById("field-configs").appendChild(row);
        }


        function openStepModal(type, id) {
            const modal = document.getElementById("step-config-modal");
            modal.dataset.stepId = id;
            modal.dataset.type = type;
            const config = allConfigs[id] || {};
            document.getElementById("modal-title").textContent = `Configure ${type} Step`;

            const fields = {
                form: `
      <label>Title: <input name="title" required value="${config.title || ''}"></label>
      <div id="field-configs"></div>
    `,
                email: `
      <label>Subject: <input name="subject" required value="${config.subject || ''}"></label>
      <label>Body:<br><textarea name="body" rows="4">${config.body || ''}</textarea></label>
    `,
                timer: `<label>Delay (in seconds): <input name="delay" type="number" min="1" required value="${config.delay || ''}"></label>`,
                approval: `<label>Approver Email: <input name="approver" value="${config.approver || ''}"></label>`,
                condition: `<label>Condition logic: <input name="logic" value="${config.logic || ''}" placeholder="e.g. amount > 10000"></label>`,
                webhook: `<label>Webhook URL: <input name="url" type="url" value="${config.url || ''}"></label>`
            };

            const body = document.getElementById("modal-body");
            body.innerHTML = fields[type] || `<p>No config available for this step type.</p>`;

            // Load existing field configs if form step
            if (type === "form") {
                const savedFields = config.fields || [];
                savedFields.forEach((field, i) => addFieldRow(field, i));

                const addFieldBtn = document.createElement("button");
                addFieldBtn.type = "button";
                addFieldBtn.textContent = "‚ûï Add Field";
                addFieldBtn.onclick = () => addFieldRow();
                document.getElementById("field-configs").after(addFieldBtn);
            }

            modal.style.display = "block";
        }


        function closeStepModal() {
            document.getElementById("step-config-modal").style.display = 'none';
        }

        function getCSRFToken() {
            return document.querySelector("[name=csrfmiddlewaretoken]").value;
        }
    </script>
{% endblock %}
